version: '3.8'

services:
  web:
    build: ./
    ports:
      - 8004:8000
    command: poetry run start
    volumes:
      - ./:/usr/src/app
    environment:
      - CELERY_BROKER=redis://redis:6379/0
      - CELERY_BACKEND=redis://redis:6379/0
      - POSTGRES_USER=monkey_user
      - POSTGRES_PASSWORD=monkey_pass
      - POSTGRES_DB=monkey_db
      - POSTGRES_SERVER=pg-0
    depends_on:
      - pg-0
      - pgpool

  worker:
    build: ./
    command: poetry run celery -A ipr.app.celery worker -P threads --loglevel=info
    volumes:
      - ./:/usr/src/app
    environment:
      - CELERY_BROKER=redis://redis:6379/0
      - CELERY_BACKEND=redis://redis:6379/0
      - POSTGRES_USER=monkey_user
      - POSTGRES_PASSWORD=monkey_pass
      - POSTGRES_DB=monkey_db
      - POSTGRES_SERVER=pg-0
    depends_on:
      - web
      - redis

  redis:
    image: redis:6-alpine

  dashboard:
    build: ./
    command: poetry run celery -A ipr.app.celery flower
    volumes:
      - ./:/usr/src/app
    ports:
      - 5556:5555
    environment:
      - CELERY_BROKER=redis://redis:6379/0
      - CELERY_BACKEND=redis://redis:6379/0
      - POSTGRES_USER=monkey_user
      - POSTGRES_PASSWORD=monkey_pass
      - POSTGRES_DB=monkey_db
      - POSTGRES_SERVER=pg-0
    depends_on:
      - worker
  # db:
  #   image: postgres:12.0-alpine
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data/
  #   environment:
  #     - POSTGRES_USER: monkey_user
  #     - POSTGRES_PASSWORD: monkey_pass
  #     - POSTGRES_DB: monkey_db
  #   expose: 
  #     - 5432

  pg-0:
    image: docker.io/bitnami/postgresql-repmgr:14
    ports:
      - 5432
    volumes:
      - pg_0_data:/bitnami/postgresql
    environment:
      - POSTGRESQL_POSTGRES_PASSWORD=adminpassword
      - POSTGRESQL_USERNAME=monkey_user
      - POSTGRESQL_PASSWORD=monkey_pass
      - POSTGRESQL_DATABASE=monkey_db
      - POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS=1
      - REPMGR_PASSWORD=repmgrpassword
      - REPMGR_PRIMARY_HOST=pg-0
      - REPMGR_PARTNER_NODES=pg-1,pg-0
      - REPMGR_NODE_NAME=pg-0
      - REPMGR_NODE_NETWORK_NAME=pg-0
  pg-1:
    image: docker.io/bitnami/postgresql-repmgr:14
    ports:
      - 5432
    volumes:
      - pg_1_data:/bitnami/postgresql
    environment:
      - POSTGRESQL_POSTGRES_PASSWORD=adminpassword
      - POSTGRESQL_USERNAME=monkey_user
      - POSTGRESQL_PASSWORD=monkey_pass
      - POSTGRESQL_DATABASE=monkey_db
      - POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS=1
      - REPMGR_PASSWORD=repmgrpassword
      - REPMGR_PRIMARY_HOST=pg-0
      - REPMGR_PARTNER_NODES=pg-0,pg-1
      - REPMGR_NODE_NAME=pg-1
      - REPMGR_NODE_NETWORK_NAME=pg-1
  pgpool:
    image: docker.io/bitnami/pgpool:4
    ports:
      - 5432:5432
    environment:
      - PGPOOL_BACKEND_NODES=0:pg-0:5432,1:pg-1:5432
      - PGPOOL_SR_CHECK_USER=monkey_user
      - PGPOOL_SR_CHECK_PASSWORD=monkey_pass
      - PGPOOL_ENABLE_LDAP=no
      - PGPOOL_POSTGRES_USERNAME=postgres
      - PGPOOL_POSTGRES_PASSWORD=adminpassword
      - PGPOOL_ADMIN_USERNAME=admin
      - PGPOOL_ADMIN_PASSWORD=adminpassword
      - PGPOOL_ENABLE_LOAD_BALANCING=yes
      - PGPOOL_MAX_POOL=1000000
      - PGPOOL_NUM_INIT_CHILDREN=10000
    healthcheck:
      test: ["CMD", "/opt/bitnami/scripts/pgpool/healthcheck.sh"]
      interval: 10s
      timeout: 5s
      retries: 5
volumes:
  pg_0_data:
  pg_1_data:
